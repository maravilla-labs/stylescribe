<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{page.title}}</title>
        {{#if branding.favicon}}
        <link rel="icon" href="/static/{{branding.favicon}}">
        {{/if}}
        <link rel="stylesheet" href="../css/stylescribe.css">
        {{#if themeOptions}}
        <link rel="stylesheet" href="../css/themes.css">
        {{/if}}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
        {{#if externalCssIncludes}}
        <style>
            {{#each externalCssIncludes}}
            @import url('{{{this}}}');
            {{/each}}
        </style>
        {{/if}}

        {{#each headIncludes}}
        <link rel="stylesheet" href="/{{this}}">
        {{/each}}

        <script src="../js/theme-init.js"></script>
    </head>
    <body hx-boost="true"
          hx-target="#stylescribe-wrapper"
          hx-select="#stylescribe-wrapper"
          hx-swap="outerHTML show:window:top"
          class="min-h-screen bg-gray-50 dark:bg-slate-900"
          data-basepath="{{basePath}}"
          data-page-type="component">
        <div id="stylescribe-wrapper">
        <!-- Navigation -->
        {{> navigation basePath=basePath branding=branding navigation=navigation groups=groups activeNav=activeNav}}

        <div class="main-content">
        <!-- Component page data for htmx re-initialization -->
        <script type="application/json" id="component-page-data">
        {
            "componentName": "{{#if page.classname}}{{page.classname}}{{else}}{{page.name}}{{/if}}",
            "classPrefix": "{{classPrefix}}",
            "type": "{{page.type}}",
            "variations": {{#if page.variations}}{{{json page.variations}}}{{else}}[]{{/if}},
            "additionalVariations": {{#if page.additional_variations}}{{{json page.additional_variations}}}{{else}}[]{{/if}},
            "elements": {{#if page.elements}}{{{json page.elements}}}{{else}}[]{{/if}},
            "maintag": "{{#if page.maintag}}{{page.maintag}}{{else}}div{{/if}}",
            "role": "{{page.role}}",
            "exampleHtml": {{#if page.examples}}{{#with (lookup page.examples 0)}}{{{json this.code}}}{{/with}}{{else}}null{{/if}}
        }
        </script>
        <div class="flex min-h-[calc(100vh-64px)]">
            <!-- Sidebar -->
            <aside class="hidden lg:block w-60 shrink-0 border-r border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <nav class="sidebar-nav max-h-[calc(100vh-64px)] overflow-y-auto">
                    {{#each groups as |groupComponents groupName|}}
                    <div class="sidebar-group">
                        <button class="sidebar-group-toggle" data-group="{{groupName}}">
                            <span>{{groupName}}</span>
                            <svg class="sidebar-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <ul class="sidebar-group-content">
                            {{#each groupComponents}}
                            <li>
                                {{#if (eq this.path ../../currentPath)}}
                                <span class="sidebar-link sidebar-link--active">
                                    {{#if this.navtitle}}{{this.navtitle}}{{else}}{{this.title}}{{/if}}
                                </span>
                                {{else}}
                                <a href="./{{this.name}}.html" class="sidebar-link">
                                    {{#if this.navtitle}}{{this.navtitle}}{{else}}{{this.title}}{{/if}}
                                </a>
                                {{/if}}
                            </li>
                            {{/each}}
                        </ul>
                    </div>
                    {{/each}}
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 min-w-0 flex justify-center py-8 px-4 md:px-8">
                <div class="max-w-3xl mx-auto">
                    <!-- Header Section -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6 mb-6 shadow-sm">
                        <div class="flex items-start justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{page.title}}</h1>
                                <p class="text-gray-600 dark:text-gray-300 text-lg">{{{page.description}}}</p>
                            </div>

                            <!-- Status Badge -->
                            {{#if page.draft}}
                            <span class="status-badge beta">
                                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                                Draft
                            </span>
                            {{else}}
                            {{#if page.verified}}
                            <span class="status-badge verified">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                Verified
                            </span>
                            {{else}}
                            <span class="status-badge deprecated">
                                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                Experimental
                            </span>
                            {{/if}}
                            {{/if}}
                        </div>

                        {{#if page.dependencies}}
                        <div class="mt-4 flex items-center gap-2 text-sm">
                            <span class="font-medium text-gray-700 dark:text-gray-300">Dependencies:</span>
                            {{#each page.dependencies}}
                            <a href="./{{this}}.html" class="text-indigo-600 dark:text-indigo-400 hover:underline">{{this}}</a>{{#unless @last}}<span class="text-gray-300 dark:text-gray-600">â€¢</span>{{/unless}}
                            {{/each}}
                        </div>
                        {{/if}}

                        <div class="code-container mt-4">
                            <button class="copy-btn">Copy</button>
                            <pre><code class="language-js">import "{{productionBasepath}}{{page.path}}/{{page.name}}.css"</code></pre>
                            <textarea class="sr-only">import "{{productionBasepath}}{{page.path}}/{{page.name}}.css"</textarea>
                        </div>
                    </div>

                    <!-- Examples Section -->
                    {{#if page.examples}}
                    <div id="examples" class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 mb-6 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Examples</h2>
                        </div>
                        {{#each page.examples}}
                        <div id="example-{{@index}}" class="p-6 {{#unless @last}}border-b border-gray-200 dark:border-slate-700{{/unless}}">
                            {{#if this.title}}
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-2">{{this.title}}</h3>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">{{this.description}}</p>
                            {{/if}}
                            <div class="preview-container mb-4">
                                <!-- Skeleton loader - shown while iframe loads -->
                                <div class="iframe-skeleton" data-skeleton-for="example-{{@index}}">
                                    <div class="iframe-skeleton__content">
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                    </div>
                                </div>
                                <iframe
                                    class="example-iframe w-full border-0"
                                    src="./{{../page.name}}-example-{{@index}}.preview.html"
                                    title="Example: {{this.title}}"
                                    data-skeleton-id="example-{{@index}}"
                                    {{#if this.height}}data-height="{{this.height}}"{{/if}}
                                    {{#if this.minHeight}}data-min-height="{{this.minHeight}}"{{/if}}
                                    {{#if this.maxHeight}}data-max-height="{{this.maxHeight}}"{{/if}}
                                    style="{{#if this.height}}height: {{this.height}}; max-height: none;{{/if}}{{#if this.minHeight}} min-height: {{this.minHeight}};{{/if}}{{#if this.maxHeight}} max-height: {{this.maxHeight}};{{/if}}">
                                </iframe>
                            </div>
                            <div class="code-container">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-html">{{prettyprint this.code}}</code></pre>
                                <textarea class="sr-only">{{prettyprint this.code}}</textarea>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}

                    <!-- Interactive Playground -->
                    {{#if page.variations}}
                    <div id="playground" class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 mb-6 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Interactive Playground</h2>
                        </div>

                        <!-- Theme Picker -->
                        <div class="px-6 pt-6">
                            {{> theme-picker themeOptions=themeOptions}}
                        </div>

                        <!-- Variant Controls -->
                        <div class="variant-controls m-6">
                            <h4>Customize Component</h4>

                            <div class="mb-4">
                                <span class="variant-label">Variation Style:</span>
                                <div id="variation-toggles" class="flex flex-wrap gap-2">
                                    {{#each page.variations}}
                                    <span class="variant-toggle" {{#if (hasDescription this)}}title="{{itemDescription this}}"{{/if}}>
                                        <input type="radio" name="variation" id="var-{{itemName this}}" value="{{itemName this}}" {{#if @first}}checked{{/if}}>
                                        <label for="var-{{itemName this}}">{{capitalizeFirst this}}</label>
                                    </span>
                                    {{/each}}
                                </div>
                            </div>

                            {{#if page.additional_variations}}
                            <div class="mb-4">
                                <span class="variant-label">Additional Modifiers:</span>
                                <div id="modifier-toggles" class="flex flex-wrap gap-2">
                                    {{#each page.additional_variations}}
                                    <span class="variant-toggle" {{#if (hasDescription this)}}title="{{itemDescription this}}"{{/if}}>
                                        <input type="checkbox" id="mod-{{itemName this}}" value="{{itemName this}}">
                                        <label for="mod-{{itemName this}}">{{capitalizeFirst this}}</label>
                                    </span>
                                    {{/each}}
                                </div>
                            </div>
                            {{/if}}

                            {{#unless (eq page.type 'utility')}}
                            {{#if page.elements}}
                            <div>
                                <span class="variant-label">Show Elements:</span>
                                <div id="element-toggles" class="flex flex-wrap gap-2">
                                    {{#each page.elements}}
                                    <span class="variant-toggle" {{#if (hasDescription this)}}title="{{itemDescription this}}"{{/if}}>
                                        <input type="checkbox" id="elem-{{itemName this}}" value="{{itemName this}}" checked>
                                        <label for="elem-{{itemName this}}">{{capitalizeFirst this}}</label>
                                    </span>
                                    {{/each}}
                                </div>
                            </div>
                            {{/if}}
                            {{/unless}}
                        </div>

                        <!-- Responsive Controls -->
                        <div class="preview-controls px-6">
                            <button class="preview-btn active" data-width="100%">Full Width</button>
                            <button class="preview-btn" data-width="375px">Mobile</button>
                            <button class="preview-btn" data-width="768px">Tablet</button>
                            <button class="preview-btn" data-width="1024px">Desktop</button>
                            <span class="ml-auto"></span>
                            <button class="preview-btn" id="bg-toggle" title="Toggle transparent background">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            </button>
                        </div>

                        <!-- Live Preview (Iframe for CSS isolation) -->
                        <div class="px-6 pb-6">
                            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Live Preview</div>
                            <div class="preview-container" id="preview-wrapper" style="width: 100%;">
                                <!-- Skeleton loader for playground -->
                                <div class="iframe-skeleton" data-skeleton-for="playground">
                                    <div class="iframe-skeleton__content">
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                    </div>
                                </div>
                                <iframe
                                    id="preview-iframe"
                                    src="./{{page.name}}-preview.html"
                                    class="w-full border-0"
                                    data-skeleton-id="playground"
                                    title="Component Preview">
                                </iframe>
                            </div>
                        </div>

                        <!-- Generated Code -->
                        <div class="border-t border-gray-200 dark:border-slate-700">
                            <div class="flex justify-between items-center px-6 py-3 bg-gray-50 dark:bg-slate-900">
                                <span class="font-medium text-gray-700 dark:text-gray-300">Generated Code</span>
                                <button class="btn-sm border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-700 dark:text-gray-300 transition-colors" id="copy-generated">Copy</button>
                            </div>
                            <div class="code-container rounded-none border-0">
                                <pre id="generated-code"><code class="language-html"></code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- All Variations Reference -->
                    <div id="variations" class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 mb-6 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">All Variations</h2>
                        </div>
                        {{#each page.variations}}
                        <div class="p-6 {{#unless @last}}border-b border-gray-200 dark:border-slate-700{{/unless}}">
                            <h3 class="font-semibold text-gray-900 dark:text-white mb-1 capitalize">{{itemName this}}</h3>
                            {{#if (hasDescription this)}}
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">{{itemDescription this}}</p>
                            {{else}}
                            <div class="mb-3"></div>
                            {{/if}}
                            <div class="preview-container mb-4">
                                <!-- Skeleton loader for variation -->
                                <div class="iframe-skeleton" data-skeleton-for="variation-{{itemName this}}">
                                    <div class="iframe-skeleton__content">
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                        <div class="iframe-skeleton__bar"></div>
                                    </div>
                                </div>
                                <iframe
                                    class="variation-iframe w-full border-0"
                                    src="./{{../page.name}}-variation-{{itemName this}}.preview.html"
                                    title="Variation: {{itemName this}}"
                                    data-skeleton-id="variation-{{itemName this}}">
                                </iframe>
                            </div>
                            <div class="code-container">
                                <pre><code class="language-html">&lt;{{#if ../page.maintag}}{{../page.maintag}}{{else}}div{{/if}} class="{{../classPrefix}}{{#if ../page.classname}}{{../page.classname}}{{else}}{{../page.name}}{{/if}} {{../classPrefix}}{{#if ../page.classname}}{{../page.classname}}{{else}}{{../page.name}}{{/if}}{{#if (eq ../page.type 'utility')}}-{{else}}--{{/if}}{{itemName this}}"&gt;
{{#each ../page.elements}}  {{elementCodeHtml this ../../classPrefix ../../page}}
{{/each}}&lt;/{{#if ../page.maintag}}{{../page.maintag}}{{else}}div{{/if}}&gt;</code></pre>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}

                    <!-- CSS Custom Properties -->
                    {{#if page.cssVars}}
                    <div id="css-vars" class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">CSS Custom Properties</h2>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Variables used by this component</p>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                {{#each page.cssVars}}
                                <div class="px-4 py-3 border border-gray-200 dark:border-slate-700 rounded-lg bg-gray-50 dark:bg-slate-900 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                                    <code class="text-sm font-mono text-indigo-600 dark:text-indigo-400">--{{this}}</code>
                                </div>
                                {{/each}}
                            </div>
                        </div>
                    </div>
                    {{/if}}

                    <!-- Used in UI Blocks -->
                    {{#if page.usedInBlocks}}
                    <div id="used-in-blocks" class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden mt-6">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-700">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Used in UI Blocks</h2>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">UI Blocks that use this component</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap gap-2">
                                {{#each page.usedInBlocks}}
                                <a href="../blocks/{{this.name}}.html" class="inline-flex items-center gap-1 px-3 py-1.5 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    {{this.title}}
                                </a>
                                {{/each}}
                            </div>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </main>

            <!-- Table of Contents -->
            <aside class="hidden xl:block w-56 shrink-0 border-l border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <nav class="toc-nav sticky top-16 max-h-[calc(100vh-64px)] overflow-y-auto p-4">
                    <h4 class="toc-title">On this page</h4>
                    <ul class="toc-list">
                        {{#if page.examples}}
                        <li class="toc-item toc-item--h2">
                            <a href="#examples" class="toc-link">Examples</a>
                        </li>
                        {{#each page.examples}}
                        <li class="toc-item toc-item--h3">
                            <a href="#example-{{@index}}" class="toc-link">{{this.title}}</a>
                        </li>
                        {{/each}}
                        {{/if}}
                        {{#if page.variations}}
                        <li class="toc-item toc-item--h2">
                            <a href="#playground" class="toc-link">Interactive Playground</a>
                        </li>
                        <li class="toc-item toc-item--h2">
                            <a href="#variations" class="toc-link">All Variations</a>
                        </li>
                        {{/if}}
                        {{#if page.cssVars}}
                        <li class="toc-item toc-item--h2">
                            <a href="#css-vars" class="toc-link">CSS Custom Properties</a>
                        </li>
                        {{/if}}
                        {{#if page.usedInBlocks}}
                        <li class="toc-item toc-item--h2">
                            <a href="#used-in-blocks" class="toc-link">Used in UI Blocks</a>
                        </li>
                        {{/if}}
                    </ul>
                </nav>
            </aside>
        </div>
        </div>

        <!-- Alpine.js (with defer for proper initialization) -->
        <script defer src="../js/alpine.min.js"></script>
        <!-- htmx for SPA navigation -->
        <script src="../js/htmx.min.js"></script>
        <script src="../js/htmx-init.js"></script>
        <!-- Alpine components -->
        <script src="../js/alpine-components.js"></script>
        <!-- Core functionality -->
        <script src="../js/init-registry.js"></script>
        <script src="{{basePath}}js/page-init.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
        <script src="https://unpkg.com/lunr/lunr.js"></script>
        <script src="../js/search.js"></script>
        <script src="../js/navigation.js"></script>
        <script>
            // Stylescribe Component Page - Re-initializable module
            // This script can be safely re-executed after htmx navigation
            (function() {
                // Read page-specific data from JSON element in swapped content
                // This allows data to be refreshed after htmx navigation
                function getPageData() {
                    var dataEl = document.getElementById('component-page-data');
                    if (dataEl) {
                        try {
                            return JSON.parse(dataEl.textContent);
                        } catch (e) {
                            console.warn('Failed to parse component page data:', e);
                        }
                    }
                    return null;
                }

                // Normalize arrays - items might be strings or objects with 'name' property
                function normalizeArray(arr) {
                    return (arr || []).map(function(item) {
                        if (typeof item === 'string') return item;
                        if (typeof item === 'object' && item !== null && item.name) return item.name;
                        return String(item);
                    });
                }

                // Cleanup function to remove old event listeners and reset state
                function cleanup() {
                    // Remove old message listener if exists
                    if (window._stylescribeMessageHandler) {
                        window.removeEventListener('message', window._stylescribeMessageHandler);
                    }
                    // Reset all skeleton loaders (for htmx navigation)
                    document.querySelectorAll('.iframe-skeleton.loaded').forEach(function(skeleton) {
                        skeleton.classList.remove('loaded');
                    });
                }

                // Initialize collapsible sidebar groups
                function initSidebarGroups() {
                    var toggles = document.querySelectorAll('.sidebar-group-toggle');
                    var storageKey = 'stylescribe-collapsed-groups';

                    var collapsedGroups = [];
                    try {
                        collapsedGroups = JSON.parse(localStorage.getItem(storageKey)) || [];
                    } catch (e) {}

                    toggles.forEach(function(toggle) {
                        // Skip if already initialized
                        if (toggle._sidebarInitialized) return;
                        toggle._sidebarInitialized = true;

                        var groupName = toggle.dataset.group;
                        var content = toggle.nextElementSibling;
                        var chevron = toggle.querySelector('.sidebar-chevron');

                        if (collapsedGroups.includes(groupName)) {
                            content.style.display = 'none';
                            chevron.style.transform = 'rotate(-90deg)';
                        }

                        toggle.addEventListener('click', function() {
                            var isCollapsed = content.style.display === 'none';
                            // Enable animation only on click
                            if (chevron) chevron.classList.add('animate');

                            if (isCollapsed) {
                                content.style.display = '';
                                chevron.style.transform = '';
                                collapsedGroups = collapsedGroups.filter(function(g) { return g !== groupName; });
                            } else {
                                content.style.display = 'none';
                                chevron.style.transform = 'rotate(-90deg)';
                                collapsedGroups.push(groupName);
                            }

                            try {
                                localStorage.setItem(storageKey, JSON.stringify(collapsedGroups));
                            } catch (e) {}
                        });
                    });
                }

                // Initialize copy buttons
                function initCopyButtons() {
                    document.querySelectorAll('.copy-btn').forEach(function(button) {
                        // Skip if already initialized
                        if (button._copyInitialized) return;
                        button._copyInitialized = true;

                        button.addEventListener('click', function() {
                            var textarea = this.parentElement.querySelector('textarea');
                            var code = textarea ? textarea.value : this.parentElement.querySelector('code').textContent;
                            navigator.clipboard.writeText(code).then(function() {
                                var originalText = button.innerText;
                                button.innerText = 'Copied!';
                                setTimeout(function() { button.innerText = originalText; }, 1500);
                            });
                        });
                    });
                }

                // Initialize interactive playground
                function initPlayground() {
                    // Get fresh page data (important after htmx navigation)
                    var pageData = getPageData();
                    if (!pageData) return null;

                    var baseClass = pageData.classPrefix + pageData.componentName;
                    var previewIframe = document.getElementById('preview-iframe');
                    var previewWrapper = document.getElementById('preview-wrapper');
                    var generatedCodeEl = document.getElementById('generated-code');

                    if (!previewIframe) return null;

                    var componentMeta = {
                        variations: normalizeArray(pageData.variations),
                        additionalVariations: normalizeArray(pageData.additionalVariations),
                        elements: normalizeArray(pageData.elements),
                        maintag: pageData.maintag,
                        role: pageData.role,
                        exampleHtml: pageData.exampleHtml
                    };

                    var iframeReady = false;

                    function generateHtml(classes, visibleElements) {
                        if (componentMeta.exampleHtml) {
                            var tempDiv = document.createElement('div');
                            tempDiv.innerHTML = componentMeta.exampleHtml.trim();
                            var root = tempDiv.firstElementChild;
                            if (root) {
                                root.className = classes.join(' ');
                                root.setAttribute('tabindex', '0');

                                componentMeta.elements.forEach(function(elem) {
                                    var elemClass = baseClass + '__' + elem;
                                    var elemNodes = root.querySelectorAll('.' + elemClass);
                                    elemNodes.forEach(function(node) {
                                        node.style.display = visibleElements.indexOf(elem) === -1 ? 'none' : '';
                                    });
                                });

                                return tempDiv.innerHTML;
                            }
                        }

                        var tag = componentMeta.maintag;
                        var role = componentMeta.role;
                        var html = '<' + tag;
                        if (role) html += ' role="' + role + '"';
                        html += ' tabindex="0" class="' + classes.join(' ') + '">';

                        visibleElements.forEach(function(elem) {
                            html += '<div class="' + baseClass + '__' + elem + '">' + elem.charAt(0).toUpperCase() + elem.slice(1) + '</div>';
                        });

                        return html + '</' + tag + '>';
                    }

                    function formatHtml(html) {
                        var indent = 0;
                        var result = '';
                        var tokens = html.replace(/>\s*</g, '>\n<').split('\n');
                        tokens.forEach(function(token) {
                            if (token.match(/^<\/\w/)) indent--;
                            result += '  '.repeat(Math.max(0, indent)) + token.trim() + '\n';
                            if (token.match(/^<\w[^>]*[^\/]>.*$/) && !token.match(/<.*>.*<\/.*>/)) indent++;
                        });
                        return result.trim();
                    }

                    function updateGeneratedCode(classes, visibleElements) {
                        var code;
                        if (componentMeta.exampleHtml) {
                            var tempDiv = document.createElement('div');
                            tempDiv.innerHTML = componentMeta.exampleHtml.trim();
                            var root = tempDiv.firstElementChild;
                            if (root) {
                                root.className = classes.join(' ');
                                root.setAttribute('tabindex', '0');
                                componentMeta.elements.forEach(function(elem) {
                                    var elemClass = baseClass + '__' + elem;
                                    var elemNodes = root.querySelectorAll('.' + elemClass);
                                    elemNodes.forEach(function(node) {
                                        node.style.display = visibleElements.indexOf(elem) === -1 ? 'none' : '';
                                    });
                                });
                                code = formatHtml(tempDiv.innerHTML);
                            }
                        }

                        if (!code) {
                            var tag = componentMeta.maintag;
                            var role = componentMeta.role;
                            code = '<' + tag;
                            if (role) code += ' role="' + role + '"';
                            code += ' tabindex="0" class="' + classes.join(' ') + '">\n';
                            visibleElements.forEach(function(elem) {
                                code += '  <div class="' + baseClass + '__' + elem + '">' + elem.charAt(0).toUpperCase() + elem.slice(1) + '</div>\n';
                            });
                            code += '</' + tag + '>';
                        }

                        if (generatedCodeEl) {
                            generatedCodeEl.querySelector('code').textContent = code;
                            if (typeof Prism !== 'undefined') {
                                Prism.highlightElement(generatedCodeEl.querySelector('code'));
                            }
                        }
                    }

                    function updatePreview() {
                        var selectedVariation = document.querySelector('input[name="variation"]:checked');
                        var variation = selectedVariation ? selectedVariation.value : '';

                        var modifiers = [];
                        document.querySelectorAll('#modifier-toggles input:checked').forEach(function(input) {
                            modifiers.push(input.value);
                        });

                        var visibleElements = [];
                        document.querySelectorAll('#element-toggles input:checked').forEach(function(input) {
                            visibleElements.push(input.value);
                        });

                        var classes = [baseClass];
                        var separator = pageData.type === 'utility' ? '-' : '--';
                        if (variation) classes.push(baseClass + separator + variation);
                        modifiers.forEach(function(mod) { classes.push(baseClass + separator + mod); });

                        var html = generateHtml(classes, visibleElements);

                        if (iframeReady && previewIframe.contentWindow) {
                            previewIframe.contentWindow.postMessage({ type: 'updatePreview', html: html }, '*');
                        }

                        updateGeneratedCode(classes, visibleElements);
                    }

                    // Event listeners for controls (with initialization guard)
                    document.querySelectorAll('#variation-toggles input').forEach(function(input) {
                        if (input._playgroundInitialized) return;
                        input._playgroundInitialized = true;
                        input.addEventListener('change', updatePreview);
                    });

                    document.querySelectorAll('#modifier-toggles input').forEach(function(input) {
                        if (input._playgroundInitialized) return;
                        input._playgroundInitialized = true;
                        input.addEventListener('change', updatePreview);
                    });

                    document.querySelectorAll('#element-toggles input').forEach(function(input) {
                        if (input._playgroundInitialized) return;
                        input._playgroundInitialized = true;
                        input.addEventListener('change', updatePreview);
                    });

                    document.querySelectorAll('.preview-btn').forEach(function(btn) {
                        if (btn._playgroundInitialized) return;
                        btn._playgroundInitialized = true;
                        btn.addEventListener('click', function() {
                            document.querySelectorAll('.preview-btn').forEach(function(b) { b.classList.remove('active'); });
                            this.classList.add('active');
                            previewWrapper.style.width = this.getAttribute('data-width');
                        });
                    });

                    var copyBtn = document.getElementById('copy-generated');
                    if (copyBtn && !copyBtn._playgroundInitialized) {
                        copyBtn._playgroundInitialized = true;
                        copyBtn.addEventListener('click', function() {
                            var code = generatedCodeEl.querySelector('code').textContent;
                            navigator.clipboard.writeText(code).then(function() {
                                var originalText = copyBtn.innerText;
                                copyBtn.innerText = 'Copied!';
                                setTimeout(function() { copyBtn.innerText = originalText; }, 1500);
                            });
                        });
                    }

                    // Background toggle for transparent components
                    var bgToggle = document.getElementById('bg-toggle');
                    if (bgToggle && !bgToggle._playgroundInitialized) {
                        bgToggle._playgroundInitialized = true;
                        var transparentBg = false;
                        bgToggle.addEventListener('click', function() {
                            transparentBg = !transparentBg;
                            bgToggle.classList.toggle('active', transparentBg);
                            if (previewIframe.contentWindow) {
                                previewIframe.contentWindow.postMessage({ type: 'setBackground', transparent: transparentBg }, '*');
                            }
                        });
                    }

                    // Store updatePreview for external access (e.g., theme changes)
                    window._stylescribeUpdatePreview = updatePreview;

                    // Return handler for message events related to this playground
                    return function(event) {
                        // Use skeletonId matching instead of window reference (more reliable)
                        if (event.data.type === 'previewReady' && event.data.skeletonId === 'playground') {
                            iframeReady = true;
                            // Hide playground skeleton
                            var playgroundSkeleton = document.querySelector('[data-skeleton-for="playground"]');
                            if (playgroundSkeleton) {
                                playgroundSkeleton.classList.add('loaded');
                            }
                            if (componentMeta.exampleHtml && previewIframe.contentWindow) {
                                previewIframe.contentWindow.postMessage({ type: 'updatePreview', html: componentMeta.exampleHtml }, '*');
                            }
                            updatePreview();
                        }
                        if (event.data.type === 'previewHeight' && event.data.skeletonId === 'playground') {
                            previewIframe.style.height = event.data.height + 'px';
                        }
                    };
                }

                // Initialize iframe height listener for example/variation iframes
                function initIframeHeightListener() {
                    return function(event) {
                        // Handle preview ready - hide skeleton loader
                        // Match by skeletonId instead of window reference (more reliable)
                        if (event.data.type === 'previewReady' && event.data.skeletonId) {
                            var skeleton = document.querySelector('[data-skeleton-for="' + event.data.skeletonId + '"]');
                            if (skeleton) {
                                skeleton.classList.add('loaded');
                            }
                        }

                        // Handle height adjustment
                        // Match by skeletonId instead of window reference (more reliable)
                        if (event.data.type === 'previewHeight' && event.data.skeletonId) {
                            var iframe = document.querySelector('[data-skeleton-id="' + event.data.skeletonId + '"]');
                            if (iframe) {
                                // Skip auto-resize if iframe has explicit height set via data-height attribute
                                if (iframe.hasAttribute('data-height') && iframe.getAttribute('data-height') !== 'auto') {
                                    return;
                                }
                                var height = event.data.height;

                                // Apply min-height constraint
                                var minHeight = iframe.getAttribute('data-min-height');
                                if (minHeight) {
                                    var minHeightPx = parseInt(minHeight, 10);
                                    if (!isNaN(minHeightPx) && height < minHeightPx) {
                                        height = minHeightPx;
                                    }
                                }

                                // Apply max-height constraint
                                var maxHeight = iframe.getAttribute('data-max-height');
                                if (maxHeight) {
                                    var maxHeightPx = parseInt(maxHeight, 10);
                                    if (!isNaN(maxHeightPx) && height > maxHeightPx) {
                                        height = maxHeightPx;
                                    }
                                }

                                iframe.style.height = height + 'px';
                            }
                        }
                    };
                }

                // Main message handler that delegates to sub-handlers
                function createMessageHandler(playgroundHandler, iframeHandler) {
                    return function(event) {
                        if (playgroundHandler) playgroundHandler(event);
                        if (iframeHandler) iframeHandler(event);
                    };
                }

                // Main initialization function
                function initAll() {
                    cleanup();

                    initSidebarGroups();
                    initCopyButtons();

                    var playgroundHandler = initPlayground();
                    var iframeHandler = initIframeHeightListener();

                    // Create and store combined message handler
                    window._stylescribeMessageHandler = createMessageHandler(playgroundHandler, iframeHandler);
                    window.addEventListener('message', window._stylescribeMessageHandler);
                }

                // Expose globally for htmx re-initialization
                window.stylescribeComponent = {
                    initAll: initAll,
                    initSidebarGroups: initSidebarGroups,
                    initCopyButtons: initCopyButtons,
                    initPlayground: initPlayground
                };

                // Register with init system for SPA navigation
                if (window.stylescribeInit) {
                    window.stylescribeInit.register('component', initAll, cleanup);
                }

                // Auto-initialize on first load
                initAll();
            })();
        </script>
        {{#if themeOptions}}
        <script>
            // Theme picker and iframe sync
            (function() {
                var themeConfig = {{{json themeOptions.config}}};
                var darkModeAttr = (themeConfig && themeConfig.darkModeAttribute) || 'dark';
                var themeClassPrefix = (themeConfig && themeConfig.themeClassPrefix) || 'theme-';

                // Get current theme state
                function getThemeState() {
                    var mode = localStorage.getItem('themeMode') || localStorage.getItem('theme') || 'light';
                    var variant = localStorage.getItem('themeVariant') || 'default';
                    var variantClass = localStorage.getItem('themeVariantClass') || '';
                    return { mode: mode, variant: variant, variantClass: variantClass };
                }

                // Apply theme to document
                function applyTheme(state) {
                    // Apply mode
                    if (state.mode === 'system') {
                        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        document.documentElement.setAttribute('data-theme', prefersDark ? darkModeAttr : 'light');
                    } else {
                        document.documentElement.setAttribute('data-theme', state.mode === 'dark' ? darkModeAttr : 'light');
                    }

                    // Apply variant class
                    document.documentElement.className = document.documentElement.className.replace(/theme-\S+/g, '').trim();
                    if (state.variant && state.variant !== 'default' && state.variantClass) {
                        document.documentElement.classList.add(state.variantClass);
                    }
                }

                // Sync theme to all iframes
                function syncThemeToIframes() {
                    var state = getThemeState();
                    var actualMode = state.mode;
                    if (state.mode === 'system') {
                        actualMode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    }

                    var message = {
                        type: 'setTheme',
                        mode: actualMode === 'dark' ? darkModeAttr : 'light',
                        variant: state.variant,
                        variantClass: state.variantClass
                    };

                    document.querySelectorAll('iframe').forEach(function(iframe) {
                        if (iframe.contentWindow) {
                            iframe.contentWindow.postMessage(message, '*');
                        }
                    });
                }

                // Mode button handlers
                document.querySelectorAll('.theme-mode-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var mode = this.getAttribute('data-mode');

                        // Update active state
                        document.querySelectorAll('.theme-mode-btn').forEach(function(b) {
                            b.classList.remove('theme-mode-active');
                        });
                        this.classList.add('theme-mode-active');

                        // Save and apply
                        localStorage.setItem('themeMode', mode);
                        localStorage.setItem('theme', mode === 'system' ?
                            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : mode);

                        applyTheme(getThemeState());
                        syncThemeToIframes();

                        // Update global theme toggle icons
                        updateThemeToggleIcons();
                    });
                });

                // Variant select handler
                var variantSelect = document.getElementById('themeVariantSelect');
                if (variantSelect) {
                    // Set initial value
                    var currentVariant = localStorage.getItem('themeVariant') || 'default';
                    variantSelect.value = currentVariant;

                    variantSelect.addEventListener('change', function() {
                        var selected = this.options[this.selectedIndex];
                        var variant = this.value;
                        var variantClass = selected.getAttribute('data-class') || '';

                        localStorage.setItem('themeVariant', variant);
                        localStorage.setItem('themeVariantClass', variantClass);

                        applyTheme(getThemeState());
                        syncThemeToIframes();
                    });
                }

                // Update theme toggle icons in navigation
                function updateThemeToggleIcons() {
                    var mode = localStorage.getItem('themeMode') || localStorage.getItem('theme') || 'light';
                    var isDark = mode === 'dark' ||
                        (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

                    document.querySelectorAll('.theme-icon-light, .theme-icon-light-mobile').forEach(function(icon) {
                        icon.classList.toggle('hidden', !isDark);
                    });
                    document.querySelectorAll('.theme-icon-dark, .theme-icon-dark-mobile').forEach(function(icon) {
                        icon.classList.toggle('hidden', isDark);
                    });
                }

                // Initialize mode buttons active state
                var currentMode = localStorage.getItem('themeMode') || localStorage.getItem('theme') || 'light';
                document.querySelectorAll('.theme-mode-btn').forEach(function(btn) {
                    if (btn.getAttribute('data-mode') === currentMode) {
                        btn.classList.add('theme-mode-active');
                    } else {
                        btn.classList.remove('theme-mode-active');
                    }
                });

                // Sync theme to iframes when they're ready
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'previewReady') {
                        syncThemeToIframes();
                    }
                });

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
                    var mode = localStorage.getItem('themeMode');
                    if (mode === 'system') {
                        applyTheme(getThemeState());
                        syncThemeToIframes();
                        updateThemeToggleIcons();
                    }
                });

                // Listen for global theme toggle changes from navigation
                window.addEventListener('themeModeChange', function(event) {
                    applyTheme(getThemeState());
                    syncThemeToIframes();
                    updateThemeToggleIcons();

                    // Update mode buttons active state to match
                    var mode = event.detail.mode;
                    document.querySelectorAll('.theme-mode-btn').forEach(function(btn) {
                        if (btn.getAttribute('data-mode') === mode) {
                            btn.classList.add('theme-mode-active');
                        } else {
                            btn.classList.remove('theme-mode-active');
                        }
                    });
                });

                // Listen for global variant changes from navigation
                window.addEventListener('themeVariantChange', function(event) {
                    applyTheme(getThemeState());
                    syncThemeToIframes();

                    // Update variant select if present
                    var variantSelect = document.getElementById('themeVariantSelect');
                    if (variantSelect) {
                        variantSelect.value = event.detail.variant;
                    }
                });
            })();
        </script>
        {{/if}}
    </body>
</html>
